{% extends "base.html" %}

{% block content %}

  <form method="post" action="{% url 'logout-url' %}">
      {% csrf_token %}
      <button type="submit">Odhlásit se</button>
  </form>

  <h1>{{ request.user.username }}</h1>
  <p>Aktuální úroveň: {{ lvl_aktual }}</p>
  <p>Potřebné XP pro další úroveň: {{ XP_potrebne_next }}</p>
  <p>Našetřeno XP: {{ XP_aktual }}</p>

<p>HP: <span id="hp-value">{{ suma_hp }}</span></p>

{% if weapon_typ == "heavy" %}
<b>Síla: <span id="strength-value">{{ suma_strength }}</span> <button class="plus-button" data-attribute="strength">+</button></p></b>
Cena: <span id="cena-strength">{{ strength_cost }}</span> goldů<br><p>
Průměrné poškození: {{ center_dmg }}<br>
Odolnost proti těžkým zbraním: {{ heavy_res }}%<br>

<p>Inteligence: <span id="intelligence-value">{{ suma_intelligence }}</span> <button class="plus-button" data-attribute="intelligence">+</button></p>
Cena: <span id="cena-intelligence">{{ intelligence_cost }}</span> goldů<br>
odolnost proti magickým zbraním: {{ magic_res }}%<br>

<p>Obratnost: <span id="dexterity-value">{{ suma_dexterity }}</span> <button class="plus-button" data-attribute="dexterity">+</button></p>
Cena: <span id="cena-dexterity">{{ dexterity_cost }}</span> goldů<br>
Odolnost proti lehkým zbraním: {{ light_res }}%<br>

{% elif weapon_typ == "light" %}
<p>Obratnost: <span id="dexterity-value">{{ suma_dexterity }}</span> <button class="plus-button" data-attribute="dexterity">+</button></p>
Cena: <span id="cena-dexterity">{{ dexterity_cost }}</span> goldů<br>
Průměrné poškození: {{ center_dmg }}<br>
Odolnost proti lehkým zbraním: {{ light_res }}%<br>

<b>Síla: <span id="strength-value">{{ suma_strength }}</span> <button class="plus-button" data-attribute="strength">+</button></p>
Cena: <span id="cena-strength">{{ strength_cost }}</span> goldů<br></b><p>
Odolnost proti těžkým zbraním: {{ heavy_res }}%<br>

<p>Inteligence: <span id="intelligence-value">{{ suma_intelligence }}</span> <button class="plus-button" data-attribute="intelligence">+</button></p>
Cena: <span id="cena-intelligence">{{ intelligence_cost }}</span> goldů<br>
Odolnost proti magickým zbraním: {{ magic_res }}%<br>

{% elif weapon_typ == "magic" %}
<p>Inteligence: <span id="intelligence-value">{{ suma_intelligence }}</span> <button class="plus-button" data-attribute="intelligence">+</button></p>
Cena: <span id="cena-intelligence">{{ intelligence_cost }}</span> goldů<br>
Průměrné poškození: {{ center_dmg }}<br>
Odolnost proti magickým zbraním: {{ magic_res }}%<br>

<b>Síla: <span id="strength-value">{{ suma_strength }}</span> <button class="plus-button" data-attribute="strength">+</button></p>
Cena: <span id="cena-strength">{{ strength_cost }}</span> goldů<br></b><p>
Odolnost proti těžkým zbraním: {{ heavy_res }}%<br>

<p>Obratnost: <span id="dexterity-value">{{ suma_dexterity }}</span> <button class="plus-button" data-attribute="dexterity">+</button></p>
Cena: <span id="cena-dexterity">{{ dexterity_cost }}</span> goldů<br>
Odolnost proti lehkým zbraním: {{ light_res }}%<br>

{% endif %}

<p>Vitalita: <span id="vitality-value">{{ suma_vitality }}</span> <button class="plus-button" data-attribute="vitality">+</button></p>
Cena: <span id="cena-vitality">{{ vitality_cost }}</span> goldů<br>
BONUS K ŽIVOTŮM: {{ atributy.hp_bonus_procenta }}%<br>

<p>Charisma: <span id="charisma-value">{{ suma_charisma }}</span> <button class="plus-button" data-attribute="charisma">+</button></p>
Cena: <span id="cena-charisma">{{ charisma_cost }}</span> goldů<br>
Šance na první úder: {{ inicial_number }}%<br>

<p>Štěstí: <span id="luck-value">{{ suma_luck }}</span> <button class="plus-button" data-attribute="luck">+</button></p>
Cena: <span id="cena-luck">{{ luck_cost }}</span> goldů<br>
Šance na kritický zásah: {{ crit_chance }}%<br>

  <ul>
    <li>Kroky: {{ request.user.steps }}</li>
    <li>Goldy: <span id="gold-value">{{ request.user.gold }}</span></li>
  </ul>
  <hr>

  <h2>Sběr goldů</h2>
  <form method="post">
      {% csrf_token %}
      <input type="hidden" name="action" value="collect_gold">
      <p>Máte k dispozici k sebrání: <span id="collected-gold">{{ collected_gold }}</span> goldů.</p>
      <p>Maximální počet goldů: {{ gold_limit }} / 8h</p>
      <p>Goldy za hodinu: {{ gold_per_hour }} / h</p>
      <button type="submit">Vybrat goldy</button>
  </form>

{% if messages %}
    <ul class="messages">
        {% for message in messages %}
            <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
        {% endfor %}
    </ul>
{% endif %}




<script>
    document.addEventListener('DOMContentLoaded', function() {
  const updateInterval = 1000; // Interval v milisekundách (1000ms = 1 sekunda)
  const elementToUpdate = document.getElementById('collected-gold'); // ID HTML elementu, který chcete aktualizovat

  function fetchAndUpdateViews() {
    fetch('/gold_per_second') // Nahraďte '/vasi-url-pro-views' skutečnou URL, která směřuje na views.py
      .then(response => {
        if (!response.ok) {
          throw new Error('Chyba sítě - odpověď nebyla ok.');
        }
        return response.json(); // Předpokládá se, že views.py vrací JSON
      })
      .then(data => {
        // Zde zpracujete data a aktualizujete HTML element
        // Předpokládá se, že data jsou objekt s klíčem 'hodnota'
        elementToUpdate.textContent = data.hodnota; 
      })
      .catch(error => {
        // Tuto část můžete ponechat, pokud chcete interně zpracovat chyby, ale nebudou se vypisovat do konzole.
        // Můžete sem přidat kód, který například zobrazí uživateli zprávu o chybě na stránce, nebo nic nedělat.
      });
  }

  // Spuštění prvního dotazu ihned po načtení stránky
  fetchAndUpdateViews();

  // Nastavení intervalu pro opakování dotazu každou sekundu
  setInterval(fetchAndUpdateViews, updateInterval);
});
</script>


<script>
    document.querySelectorAll('.plus-button').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const attribute = this.dataset.attribute;
            const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;

            fetch('{% url "update-attribute-url" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ attribute: attribute })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // aktualizace konkrétního atributu
                    const attributeSpan = document.getElementById(attribute + '-value');
                    if (attributeSpan) {
                        attributeSpan.textContent = data.new_value;
                    }

                    // aktualizace cen
                    if (data.new_prices) {
                        for (const price_attribute in data.new_prices) {
                            const priceSpan = document.getElementById('cena-' + price_attribute.replace('_price', ''));
                            if (priceSpan) {
                                priceSpan.textContent = data.new_prices[price_attribute];
                            }
                        }
                    }

                    // mapa klíčů z API → id elementů
                    const updates = {
                        new_golds: 'gold-value',
                        new_hp: 'hp-value',
                        // kdybys měl víc hodnot, stačí jen přidat do mapy
                        // new_mana: 'mana-value',
                        // new_xp: 'xp-value'
                    };

                    for (const key in updates) {
                        if (data[key] !== undefined) {
                            const span = document.getElementById(updates[key]);
                            if (span) {
                                span.textContent = data[key];
                            }
                        }
                    }

                } else {
                    alert(data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Při aktualizaci atributu došlo k chybě.');
            });
        });
    });
</script>



{% endblock content %}