{% extends "base.html" %}

{% block content %}

  <form method="post" action="{% url 'logout-url' %}">
      {% csrf_token %}
      <button type="submit">Odhlásit se</button>
  </form>

  <h1>{{ request.user.username }}</h1>
  <p>Aktuální úroveň: {{ lvl_aktual }}</p>
  <p>Potřebné XP pro další úroveň: {{ XP_potrebne_next }}</p>
  <p>Našetřeno XP: {{ XP_aktual }}</p>

<p>HP: <span id="hp-value">{{ atributy.HP }}</span></p>

<p>Strength: <span id="strength-value">{{ atributy.strength }}</span> <button class="upgrade-btn" data-attribute="strength">+</button></p>
Cena: <span id="cena-strength">{{ cena_strength }}</span> goldů<br>

<p>Intelligence: <span id="intelligence-value">{{ atributy.intelligence }}</span> <button class="upgrade-btn" data-attribute="intelligence">+</button></p>
Cena: <span id="cena-intelligence">{{ cena_intelligence }}</span> goldů<br>

<p>Vitality: <span id="vitality-value">{{ atributy.vitality }}</span> <button class="upgrade-btn" data-attribute="vitality">+</button></p>
Cena: <span id="cena-vitality">{{ cena_vitality }}</span> goldů<br>

<p>Dexterity: <span id="dexterity-value">{{ atributy.dexterity }}</span> <button class="upgrade-btn" data-attribute="dexterity">+</button></p>
Cena: <span id="cena-dexterity">{{ cena_dexterity }}</span> goldů<br>

<p>Charisma: <span id="charisma-value">{{ atributy.charisma }}</span> <button class="upgrade-btn" data-attribute="charisma">+</button></p>
Cena: <span id="cena-charisma">{{ cena_charisma }}</span> goldů<br>

<p>Skill: <span id="skill-value">{{ atributy.skill }}</span> <button class="upgrade-btn" data-attribute="skill">+</button></p>
Cena: <span id="cena-skill">{{ cena_skill }}</span> goldů<br>


  <ul>
    <li>Kroky: {{ request.user.steps }}</li>
    <li>Goldy: <span id="gold-value">{{ request.user.gold }}</span></li>
  </ul>
  <hr>

  <h2>Sběr goldů</h2>
  <form method="post">
      {% csrf_token %}
      <input type="hidden" name="action" value="collect_gold">
      <p>Máte k dispozici k sebrání: <span id="collected-gold">{{ collected_gold }}</span> goldů.</p>
      <p>Maximální počet goldů: {{ gold_limit }} / 8h</p>
      <p>Goldy za hodinu: {{ gold_per_hour }} / h</p>
      <button type="submit">Vybrat goldy</button>
  </form>

{% if messages %}
    <ul class="messages">
        {% for message in messages %}
            <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
        {% endfor %}
    </ul>
{% endif %}

<div id="error-message" class="alert alert-danger d-none mt-3" role="alert"></div>


<script>
    document.addEventListener('DOMContentLoaded', function() {
        const updateInterval = 1000;
        const collectedGoldElement = document.getElementById('collected-gold');
        const upgradeButtons = document.querySelectorAll('.upgrade-btn');
        const goldValueElement = document.getElementById('gold-value');
        const errorMessageElement = document.getElementById('error-message');

        function fetchAndUpdateCollectedGold() {
            fetch('/gold_per_second')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Chyba sítě - odpověď nebyla ok.');
                    }
                    return response.json();
                })
                .then(data => {
                    if (collectedGoldElement) {
                        collectedGoldElement.textContent = data.hodnota;
                    }
                })
                .catch(error => {
                    console.error('Došlo k chybě při načítání goldů:', error);
                });
        }

        // Spuštění prvního dotazu ihned po načtení stránky
        fetchAndUpdateCollectedGold();

        // Nastavení intervalu pro opakování dotazu
        setInterval(fetchAndUpdateCollectedGold, updateInterval);

        // Funkcionalita pro vylepšení atributů
        upgradeButtons.forEach(button => {
            button.addEventListener('click', async (e) => {
                const attributeName = e.target.dataset.attribute;

                errorMessageElement.classList.add('d-none');
                errorMessageElement.textContent = '';

                try {
                    const response = await fetch('/hrac/upgrade_attribute/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCsrfToken()
                        },
                        body: JSON.stringify({ 'attribute': attributeName })
                    });

                    const data = await response.json();

                    if (data.success) {
                        const attributeValueElement = document.getElementById(`${attributeName}-value`);
                        if (attributeValueElement) {
                            attributeValueElement.textContent = data.new_value;
                        }

                        if (goldValueElement) {
                            goldValueElement.textContent = data.new_gold;
                        }

                        // Aktualizace cen pro všechny atributy (pokud je view funkce vrací)
                        if (data.new_prices) {
                            for (const price_attribute in data.new_prices) {
                                const priceSpan = document.getElementById('cena-' + price_attribute.replace('_price', ''));
                                if (priceSpan) {
                                    priceSpan.textContent = data.new_prices[price_attribute];
                                }
                            }
                        }

                    } else {
                        errorMessageElement.textContent = data.error;
                        errorMessageElement.classList.remove('d-none');
                    }
                } catch (error) {
                    console.error('Došlo k chybě:', error);
                    errorMessageElement.textContent = 'Došlo k neočekávané chybě. Zkuste to prosím znovu.';
                    errorMessageElement.classList.remove('d-none');
                }
            });
        });

        function getCsrfToken() {
            const tokenInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
            return tokenInput ? tokenInput.value : '';
        }
    });
</script>


{% endblock content %}